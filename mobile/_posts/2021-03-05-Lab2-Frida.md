In this lab we'll take a look at Frida.

# disclaimer
Not all tools/files/VMs/networks will be available. These are notes taken for labs duiring a course, so some stuff is copyright protected and can't be shared. Where possible I'll try to link the resources.

# Frida
In this second part we will investigate some basic frida functionality

# Prerequisites
* A routed android device/emulator
* Make sure you are root (adb root)

# Goal
* Frida-server is installed on the rooted android. [frida docs](https://frida.re/docs/android/)
* Execution of basic frida commands is possible.


# labs
## Setup
I'm creating a new AVD using the pixel 3a XL with API lvl 30 and call this AVD ``Pixel 3a - Frida``.

confirm the divce is ready for the lab:
* ``adb devices`` -> The device has to show up in the list
* ``adb root`` -> message should say: ``restarting adbd as root``

## 0. Installing Frida
* download the [latest version of frida server](https://github.com/frida/frida/releases) (in my case [frida-server-14.2.13-android-x86.xz](https://github.com/frida/frida/releases/download/14.2.13/frida-server-14.2.13-android-x86.xz))
* extract the archive (rename to ``frida-server`` to make next steps easier)
* put the new file on the android phone 
	* ``adb root`` (Just to make life easier and not to deal with permission errors)
	* ``adb push frida-server /data/local/tmp/``
	* Change the premissions of the file: ``adb shell "chmod 755 /data/local/tmp/frida-server"``
	* Execute Frida-server: ``adb shell "/data/local/tmp/frida-server &"`` - It will look like the server takes a lot of time to start, this is normal. You can press <ctrl+c> to get back to the normal command line without quitting the server. If you want to quit the firda server you can run ``adb shell pkill frida``. Once the frida server is started you won't be able to start a second one.
* Install frida for python on your host machine: ``pip install frida frida-tools``. This is important for next steps

### Testing the installation:
Now we can do a quick test if frida was installed correctly on the AVD and on our host by running a simple command to show all processes on the device:

``frida-ps -U``

* If you see the processes that means the installation worked.
* If you get a error ``frida-ps`` not found that means the installation on the host device did not work, if so you can follow the [manual installation guide](https://frida.re/docs/installation/) from frida.
* If you get any other error it's highly possible that the installation did not work on the AVD device. To solve these problems you can follow the [official android guide](https://frida.re/docs/android/)

## 1. Killing processes
To demonstrate how we can kill a process through frida we first have to start an application; let's say google chrome.

Sadly killing a process isn't as easy as just using ``frida-kill <PID>``. Frida needs to know on what device the porcess needs to be killed. The syntax for this command is:

``frida-kill -D <DEVICE-ID> <PID>``

* First we need to find the device ID:
	* ``frida-ls-devices`` The first column is the device ID
	* In my case the device ID is: ``emulator-5554``
* Now we need to find the process ID of chrome:
	* ``frida-ps -U | select-string chrome`` As in our initial test we can see that the ``frida-ps`` command shows the processes running on the device, I combine it with the powershell cmdlet ``select-string`` (the PS variant of ``grep``) to look for the string ``chrome``. This gives me a much smaller list to work with.
	* In my case the PID & name of chrome is ``6392  com.android.chrome``

Combining what we've done above here we can execute the command to kill chrome:

``frida-kill -D emulator-5554 6392``

And if all goes well you should also see the chrome window closing on the AVD.

## 2. Tracing Network calls
There are a few important things to know before we can start the ``frida-trace`` command has multiple options, let's break down the ones we need:
* ``-R, --remote``: for when a devices is connected remotely over wifi
* ``-U, --usb``: When a device is connected through USB (like our emulator, using this option we won't have to specify the device name unless there are multiple devices connected)
* ``-D <id>, --device=<id>``: Same as the ``-D`` option in the ``frida-kill`` command
* ``-p <PID>, --attach-pid=<PID>``: specify to what process frida needs to attach itself
* ``-f <FILE>, --file:<FILE>``: spawning a program (in our case this will be ``com.android.chrome``)
* ``-i <function>, --include=<function>``: including a function to watch when the program is running

Knowing this we can start building our frida command:

``frida-trace -U -i open -f com.android.chrome`` (This might have to chage)

## 3. The frida shell


# resources:
* [frida host installation](https://frida.re/docs/installation/)
* [frida docs](https://frida.re/docs/android/)
* [latest version of frida server](https://github.com/frida/frida/releases)
* [frida-ls-devices](https://frida.re/docs/frida-ls-devices/)
* [frida-kill](https://frida.re/docs/frida-kill/)
* [frida-trace](https://frida.re/docs/frida-trace/)